#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

param select /data/px4/param/parameters

# Make sure we are running at 800Hz on IMU
param set IMU_GYRO_RATEMAX 800

# Set the ESC outputs to function as motors
param set UART_ESC_FUNC1 101
param set UART_ESC_FUNC2 104
param set UART_ESC_FUNC3 102
param set UART_ESC_FUNC4 103

param set UART_ESC_REV 1

param set UART_ESC_CONFIG 1
param set UART_ESC_BAUD 2000000
param set UART_ESC_RPM_MAX 18000
param set UART_ESC_RPM_MIN 1000

# Some parameters for control allocation
param set CA_ROTOR_COUNT 4
param set CA_AIRFRAME 0
param set CA_ROTOR_COUNT 4
param set CA_ROTOR0_PX 0.15
param set CA_ROTOR0_PY 0.15
param set CA_ROTOR1_PX -0.15
param set CA_ROTOR1_PY -0.15
param set CA_ROTOR2_PX 0.15
param set CA_ROTOR2_PY -0.15
# param set CA_ROTOR2_KM -0.05
param set CA_ROTOR3_PX -0.15
param set CA_ROTOR3_PY 0.15
# param set CA_ROTOR3_KM -0.05

# Some parameter settings to disable / ignore certain preflight checks

# Allow arming without a barometer (Need barometer driver)
param set SYS_HAS_BARO 0

# Allow arming wihtout a magnetometer (Need magnetometer driver)
param set SYS_HAS_MAG 0
param set EKF2_MAG_TYPE	5

# Allow arming without battery check (Need voxlpm driver)
param set CBRK_SUPPLY_CHK 894281

# Allow arming wihtout CPU load information
param set COM_CPU_MAX 0.0

# Disable auto disarm. This is number of seconds to wait for takeoff
# after arming. If no takeoff happens then it will disarm. A negative
# value disables this.
param set COM_DISARM_PRFLT -1

# This parameter doesn't exist anymore. Need to see what the new method is.
# param set MAV_BROADCAST 0

# Doesn't work without setting this to Quadcopter
param set MAV_TYPE 2

# Parameters that we don't use but QGC complains about if they aren't there
param set SYS_AUTOSTART 4001

# Default RC channel mappings
param set RC_MAP_ACRO_SW 0
param set RC_MAP_ARM_SW 0
param set RC_MAP_AUX1 0
param set RC_MAP_AUX2 0
param set RC_MAP_AUX3 0
param set RC_MAP_AUX4 0
param set RC_MAP_AUX5 0
param set RC_MAP_AUX6 0
param set RC_MAP_FAILSAFE 0
param set RC_MAP_FLAPS 0
param set RC_MAP_FLTMODE 6
param set RC_MAP_GEAR_SW 0
param set RC_MAP_KILL_SW 7
param set RC_MAP_LOITER_SW 0
param set RC_MAP_MAN_SW 0
param set RC_MAP_MODE_SW 0
param set RC_MAP_OFFB_SW 0
param set RC_MAP_PARAM1 0
param set RC_MAP_PARAM2 0
param set RC_MAP_PARAM3 0
param set RC_MAP_PITCH 2
param set RC_MAP_POSCTL_SW 0
param set RC_MAP_RATT_SW 0
param set RC_MAP_RETURN_SW 0
param set RC_MAP_ROLL 1
param set RC_MAP_STAB_SW 0
param set RC_MAP_THROTTLE 3
param set RC_MAP_TRANS_SW 0
param set RC_MAP_YAW 4

param save

sleep 2

# Need px4-shutdown otherwise Linux system shutdown is called
px4-shutdown
