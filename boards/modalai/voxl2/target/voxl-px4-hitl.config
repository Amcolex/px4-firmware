#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

if [ $TESTMODE = "ON" ]; then
    /bin/echo "Running self tests"
    muorb test
    MUORB_TEST_STATUS=$?
    if [ $MUORB_TEST_STATUS -ne 0 ]; then
        /bin/echo "muorb test failed"
        shutdown
        exit 0
    else
        /bin/echo "muorb test passed"
    fi
fi

muorb start

# Sleep a little here. A lot happens when the uorb and muorb start
# and we need to make sure that it all completes successfully to avoid
# any possible race conditions.
/bin/sleep 1

param select /data/px4/param/parameters-hitl
param load

logger start -e -t -b 200

/bin/sleep 1

set VEHICLE_TYPE mc

# MAV_TYPE_QUADROTOR 2
param set MAV_TYPE 2

if param compare IMU_GYRO_RATEMAX 400
then
	        param set IMU_GYRO_RATEMAX 800
	fi

param set NAV_ACC_RAD 2

param set RTL_RETURN_ALT 30
param set RTL_DESCEND_ALT 10

param set GPS_UBX_DYNMODEL 6


param touch SYS_AUTOCONFIG
param set CBRK_SUPPLY_CHK 894281
param set COM_DISARM_PRFLT -1
param set COM_RC_IN_MODE 1
param set NAV_RCL_ACT -1
param set SYS_HITL 1
param set SYS_AUTOSTART 1001
#param set HIL_ACT_FUNC1 101
#param set HIL_ACT_FUNC2 102
#param set HIL_ACT_FUNC3 103
#param set HIL_ACT_FUNC4 104
param set UAVCAN_ENABLE 0

param set CA_ROTOR_COUNT 4
param set CA_ROTOR0_PX 0.15
param set CA_ROTOR0_PY 0.15
param set CA_ROTOR1_PX -0.15
param set CA_ROTOR1_PY -0.15
param set CA_ROTOR2_PX 0.15
param set CA_ROTOR2_PY -0.15
param set CA_ROTOR2_KM -0.05
param set CA_ROTOR3_PX -0.15
param set CA_ROTOR3_PY 0.15
param set CA_ROTOR3_KM -0.05

param set HIL_ACT_FUNC1 101
param set HIL_ACT_FUNC2 102
param set HIL_ACT_FUNC3 103
param set HIL_ACT_FUNC4 104

# disable some checks to allow to fly
# - with usb
param set CBRK_USB_CHK 197848
# - without real battery
param set CBRK_SUPPLY_CHK 894281
# - without safety switch
param set COM_PREARM_MODE 0
param set CBRK_IO_SAFETY 22027


param set MAV_TYPE 2
param set COM_CPU_MAX -1
param set SYS_HAS_MAG 1
param set EKF2_MAG_TYPE 0
#param set EKF2_MULTI_MAG 4
#param set SENS_MAG_MODE 1

# Start all of the processing modules on DSP
qshell sensors start -hil
qshell ekf2 start
qshell mc_pos_control start
qshell mc_att_control start
qshell mc_rate_control start
qshell mc_hover_thrust_estimator start
qshell land_detector start multicopter

/bin/sleep 1

# Start all of the processing modules on the applications processor
rc_update start
manual_control start
control_allocator start
dataman start
navigator start
commander start -h
commander mode manual

# This is needed for altitude and position hold modes
flight_mode_manager start

# Start simulator modules
#qshell sensor_mag_sim start
qshell battery_simulator start
qshell pwm_out_sim start -m hil
qshell simulator_mavlink start

# Bootup mavlink
mavlink start -x -u 14556 -o 14557 -r 100000 -n lo -m onboard

mavlink stream -r 200 -s HIL_ACTUATOR_CONTROLS -u 14556

## slow down some of the fastest streams in onboard mode
#mavlink stream -u 14556 -s HIGHRES_IMU -r 10
#mavlink stream -u 14556 -s ATTITUDE -r 10
#mavlink stream -u 14556 -s ATTITUDE_QUATERNION -r 10
## speed up rc_channels
#mavlink stream -u 14556 -s RC_CHANNELS -r 50


mavlink boot_complete
