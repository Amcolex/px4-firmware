#!/bin/bash

# Make sure that the SLPI DSP test signature is there otherwise px4 cannot run
# on the DSP
if /bin/ls /usr/lib/rfsa/adsp/testsig-*.so &> /dev/null; then
    /bin/echo "Found DSP signature file"
else
    /bin/echo "Error, could not find DSP signature file"
    # Look for the DSP signature generation script
    if [ -f /share/modalai/qrb5165-slpi-test-sig/generate-test-sig.sh ]; then
        /bin/echo "Attempting to generate the DSP signature file"
        # Automatically generate the test signature so that px4 can run on SLPI DSP
        /share/modalai/qrb5165-slpi-test-sig/generate-test-sig.sh
    else
        /bin/echo "Could not find the DSP signature file generation script"
        exit 0
    fi
fi

# Make sure to setup all of the needed px4 aliases.
# TODO: Put these in package installation script
cd /usr/bin
/bin/ln -f -s px4 px4-muorb
/bin/ln -f -s px4 px4-param
/bin/ln -f -s px4 px4-logger
/bin/ln -f -s px4 px4-qshell
/bin/ln -f -s px4 px4-rc_update
/bin/ln -f -s px4 px4-manual_control
/bin/ln -f -s px4 px4-control_allocator
/bin/ln -f -s px4 px4-mavlink
/bin/ln -f -s px4 px4-flight_mode_manager
/bin/ln -f -s px4 px4-commander
/bin/ln -f -s px4 px4-navigator
/bin/ln -f -s px4 px4-dataman
/bin/ln -f -s px4 px4-shutdown
cd -

# Make sure any required directories exist
mkdir -p /data/px4/param

DAEMON=" "
S="OFF"
R="SPEKTRUM"

while getopts "dsifrc" flag
do
    case "${flag}" in
        # Use -d to put PX4 into daemon mode
        d) DAEMON="-d";;
        # Use -s to run self tests
        s) S="ON";;
        # Use -i to specify IMU rotation of ROTATION_YAW_180
        i) I="ROTATE_IMU_YAW_180";;
        # Use -f to specify fake rc input instead of from a real transmitter
        f) R="FAKE_RC_INPUT";;
        # Use -r to specify TBS Crossfire RC receiver, MAVLINK
        r) R="CRSF_MAV";;
        # Use -r to specify TBS Crossfire RC receiver, raw
        c) R="CRSF_RAW";;
    esac
done

if [ ! -f /data/px4/param/parameters ]; then
   echo "Setting default parameters for PX4 on voxl"
   px4 $DAEMON -s /etc/modalai/voxl-px4-set-default-parameters.config
   /bin/sync
fi

TESTMODE=$S RC=$R IMU=$I px4 $DAEMON -s /etc/modalai/voxl-px4.config
